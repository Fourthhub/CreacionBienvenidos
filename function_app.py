
import logging
import os
import base64
from io import BytesIO
import requests
from datetime import datetime
from weasyprint import HTML
from sendgrid import SendGridAPIClient
from sendgrid.helpers.mail import Mail, Attachment, FileContent, FileName, FileType, Disposition,To
import azure.functions as func

URL_HOSTAWAY_TOKEN = "https://api.hostaway.com/v1/accessTokens"
app = func.FunctionApp()
def enviarMail(reservas,token):
    base_html = """<!DOCTYPE html><html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:o="urn:schemas-microsoft-com:office:office" lang="en" style="box-sizing: border-box;"><head style="box-sizing: border-box;"><title style="box-sizing: border-box;"></title><meta http-equiv="Content-Type" content="text/html; charset=utf-8" style="box-sizing: border-box;"><meta name="viewport" content="width=device-width,initial-scale=1" style="box-sizing: border-box;"><!--[if mso]><xml><o:officedocumentsettings><o:pixelsperinch>96</o:pixelsperinch><o:allowpng></o:officedocumentsettings></xml><![endif]--><!--[if !mso]><!--><!--<![endif]--></head><body style="background-color: #fff;margin: 0;padding: 0;-webkit-text-size-adjust: none;text-size-adjust: none;box-sizing: border-box;"><table class="nl-container" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;background-color: #fff;box-sizing: border-box;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box;"><table class="row row-1" align="center" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box;"><table class="row-content stack" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;border-radius: 10px;color: #000;width: 785px;margin: 0 auto;box-sizing: border-box;" width="785"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="column column-1" width="100%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 10px;padding-left: 20px;padding-right: 20px;padding-top: 10px;vertical-align: top;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="image_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 15px;padding-right: 15px;width: 100%;box-sizing: border-box;"><div class="alignment" align="center" style="line-height: 10px;box-sizing: border-box;"><div style="max-width: 223.5px;box-sizing: border-box;"><img src="https://d487b3526b.imgdist.com/public/users/Integrators/BeeProAgency/1147963_1133632/Logo%20AC%202024%281%29.svg" style="display: block;height: auto;border: 0;width: 100%;box-sizing: border-box;" width="223.5" height="auto"></div></div></td></tr></table><table class="heading_block block-2" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 5px;padding-left: 15px;padding-right: 15px;padding-top: 5px;text-align: center;width: 100%;box-sizing: border-box;"><h1 style="margin: 0;color: #393939;direction: ltr;font-family: 'Helvetica Neue',Helvetica,Arial,sans-serif;font-size: 32px;font-weight: 700;letter-spacing: -1px;line-height: 120%;text-align: center;margin-top: 0;margin-bottom: 0;mso-line-height-alt: 38.4px;box-sizing: border-box;"><span class="tinyMce-placeholder" style="box-sizing: border-box;">{Apartamento}<br style="box-sizing: border-box;"></span></h1></td></tr></table><table class="divider_block block-3" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-left: 10px;padding-right: 10px;box-sizing: border-box;"><div class="alignment" align="center" style="box-sizing: border-box;"><table border="0" cellpadding="0" cellspacing="0" role="presentation" width="65%" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="divider_inner" style="font-size: 1px;line-height: 1px;border-top: 2px solid #3d3d3d;box-sizing: border-box;"><span style="box-sizing: border-box;">&#8202;</span></td></tr></table></div></td></tr></table><table class="heading_block block-4" width="100%" border="0" cellpadding="10" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="box-sizing: border-box;"><h3 style="margin: 0;color: #3e3e3e;direction: ltr;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;font-size: 22px;font-weight: 400;letter-spacing: normal;line-height: 120%;text-align: center;margin-top: 0;margin-bottom: 0;mso-line-height-alt: 26.4px;box-sizing: border-box;"><span class="tinyMce-placeholder" style="box-sizing: border-box;">{Nombre}</span></h3></td></tr></table></td></tr></tbody></table></td></tr></tbody></table><table class="row row-2" align="center" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box;"><table class="row-content stack" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;background-color: #d4d4d4;border-bottom: 17px solid transparent;border-left: 17px solid transparent;border-radius: 30px;border-right: 17px solid transparent;border-top: 17px solid transparent;color: #000;width: 785px;margin: 0 auto;box-sizing: border-box;" width="785"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="column column-1" width="25%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;vertical-align: top;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="text_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 50px;padding-right: 10px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #000;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;"><u style="box-sizing: border-box;"><span style="font-size: 16px;box-sizing: border-box;"><strong style="box-sizing: border-box;">PAGOS</strong></span></u></p></div></div></td></tr></table><table class="text_block block-2" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 50px;padding-right: 10px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #000;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;text-align: left;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;"><span style="font-size: 16px;box-sizing: border-box;">Total Estancia:</span></p></div></div></td></tr></table><table class="text_block block-3" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 50px;padding-right: 10px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #000;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;text-align: left;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;"><span style="font-size: 14px;box-sizing: border-box;">Realizado:</span></p></div></div></td></tr></table><table class="text_block block-4" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 50px;padding-right: 10px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: 'Trebuchet MS',Tahoma,sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #080808;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;text-align: left;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;"><span style="font-size: 14px;box-sizing: border-box;">A pagar:</span></p></div></div></td></tr></table></td><td class="column column-2" width="25%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 5px;padding-top: 5px;vertical-align: top;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="text_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 20px;padding-right: 10px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #555;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;"><span style="font-size: 16px;box-sizing: border-box;">&nbsp;</span></p></div></div></td></tr></table><table class="text_block block-2" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 10px;padding-right: 20px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #000;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;text-align: right;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;"><span style="font-size: 14px;box-sizing: border-box;">{Total_estancia}</span></p></div></div></td></tr></table><table class="text_block block-3" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 10px;padding-right: 20px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #000;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;text-align: right;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;"><span style="font-size: 14px;box-sizing: border-box;">{Pagado}</span></p></div></div></td></tr></table><table class="text_block block-4" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 10px;padding-right: 20px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #000;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;text-align: right;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;"><span style="font-size: 14px;box-sizing: border-box;">{restante}</span></p></div></div></td></tr></table></td><td class="column column-3" width="50%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 5px;padding-top: 5px;vertical-align: top;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="text_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 40px;padding-right: 10px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #000;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;"><span style="font-size: 16px;box-sizing: border-box;"><u style="box-sizing: border-box;"><strong style="box-sizing: border-box;">DETALLES</strong></u></span></p></div></div></td></tr></table><table class="text_block block-2" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 40px;padding-right: 10px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #000;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;">üìç {address}</p></div></div></td></tr></table><table class="text_block block-3" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 40px;padding-right: 10px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #000;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;">üìÜ &nbsp;Del {fechachekin} al {fechacheckout}</p></div></div></td></tr></table><table class="text_block block-4" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;padding-left: 40px;padding-right: 10px;padding-top: 10px;box-sizing: border-box;"><div style="font-family: sans-serif;box-sizing: border-box;"><div class style="font-size: 12px;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;mso-line-height-alt: 14.399999999999999px;color: #000;line-height: 1.2;box-sizing: border-box;"><p style="margin: 0;font-size: 12px;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;line-height: inherit;">üë§ &nbsp;{Numero_de_huespeds}</p></div></div></td></tr></table></td></tr></tbody></table></td></tr></tbody></table><table class="row row-3" align="center" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box;"><table class="row-content stack" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;color: #000;width: 785px;margin: 0 auto;box-sizing: border-box;" width="785"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="column column-1" width="100%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-top: 5px;vertical-align: top;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="paragraph_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="box-sizing: border-box;"><div style="color: #101112;direction: ltr;font-family: Montserrat,'Trebuchet MS','Lucida Grande','Lucida Sans Unicode','Lucida Sans',Tahoma,sans-serif;font-size: 9px;font-weight: 400;letter-spacing: 0;line-height: 120%;text-align: center;mso-line-height-alt: 10.799999999999999px;box-sizing: border-box;"><p style="margin: 0;box-sizing: border-box;line-height: inherit;">----{facturacion}----</p></div></td></tr></table></td></tr></tbody></table></td></tr></tbody></table><table class="row row-4" align="center" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box;"><table class="row-content stack" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;background-color: #fff;color: #000;border-radius: 2px;width: 785px;margin: 0 auto;box-sizing: border-box;" width="785"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="column column-1" width="25%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 20px;padding-left: 20px;padding-right: 10px;padding-top: 20px;vertical-align: middle;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="image_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="width: 100%;padding-right: 0;padding-left: 0;box-sizing: border-box;"><div class="alignment" align="center" style="line-height: 10px;box-sizing: border-box;"><div style="max-width: 74.812px;box-sizing: border-box;"><img src="https://d487b3526b.imgdist.com/pub/bfra/tk3qo566/9rf/x64/d4m/verificado.png" style="display: block;height: auto;border: 0;width: 100%;box-sizing: border-box;" width="74.812" alt="Headset Icon" title="Headset Icon" height="auto"></div></div></td></tr></table></td><td class="column column-2" width="75%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 20px;padding-left: 10px;padding-right: 20px;padding-top: 20px;vertical-align: middle;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="paragraph_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-right: 10px;box-sizing: border-box;"><div style="color: #3d3d3d;direction: ltr;font-family: 'Helvetica Neue',Helvetica,Arial,sans-serif;font-size: 14px;font-weight: 400;letter-spacing: 0;line-height: 120%;text-align: left;mso-line-height-alt: 16.8px;box-sizing: border-box;"><p style="margin: 0;box-sizing: border-box;line-height: inherit;">Al momento de completar el check-in se realizar√° una<strong style="box-sizing: border-box;">retenci√≥n bancaria&nbsp;de 150‚Ç¨</strong>como garant√≠a de posibles deterioros de la vivienda, perdida de llaves, retraso en la salida √≥ limpieza final. Esta retenci√≥n se liberar√° tras la revisi√≥n del alojamiento posterior al check-out.</p></div></td></tr></table></td></tr></tbody></table></td></tr></tbody></table><table class="row row-5" align="center" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box;"><table class="row-content stack" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;border-radius: 0;color: #000;width: 785px;margin: 0 auto;box-sizing: border-box;" width="785"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="column column-1" width="25%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 10px;padding-left: 20px;padding-right: 10px;padding-top: 10px;vertical-align: middle;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="image_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="width: 100%;padding-right: 0;padding-left: 0;box-sizing: border-box;"><div class="alignment" align="center" style="line-height: 10px;box-sizing: border-box;"><div style="max-width: 83.125px;box-sizing: border-box;"><img src="https://d487b3526b.imgdist.com/pub/bfra/tk3qo566/l0w/k40/183/ruido.png" style="display: block;height: auto;border: 0;width: 100%;box-sizing: border-box;" width="83.125" alt="Paper Sheet With a Chart Icon" title="Paper Sheet With a Chart Icon" height="auto"></div></div></td></tr></table></td><td class="column column-2" width="75%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 20px;padding-left: 10px;padding-right: 20px;padding-top: 20px;vertical-align: middle;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="paragraph_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="box-sizing: border-box;"><div style="color: #3d3d3d;direction: ltr;font-family: 'Helvetica Neue',Helvetica,Arial,sans-serif;font-size: 14px;font-weight: 400;letter-spacing: 0;line-height: 120%;text-align: left;mso-line-height-alt: 16.8px;box-sizing: border-box;"><p style="margin: 0;box-sizing: border-box;line-height: inherit;">Los hu√©spedes deben<strong style="box-sizing: border-box;">respetar un horario de silencio</strong>de 23:00 a 08:00 horas, mantener las √°reas comunes limpias y ordenadas, y tratar a todos con respeto y cortes√≠a. El incumplimiento de estas normas puede resultar en medidas correctivas, incluido el desalojo sin reembolso.</p></div></td></tr></table></td></tr></tbody></table></td></tr></tbody></table><table class="row row-6" align="center" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box;"><table class="row-content stack" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;border-radius: 0;color: #000;width: 785px;margin: 0 auto;box-sizing: border-box;" width="785"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="column column-1" width="25%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-left: 20px;padding-right: 10px;vertical-align: middle;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="image_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="width: 100%;padding-right: 0;padding-left: 0;box-sizing: border-box;"><div class="alignment" align="center" style="line-height: 10px;box-sizing: border-box;"><div style="max-width: 83.125px;box-sizing: border-box;"><img src="https://d487b3526b.imgdist.com/pub/bfra/tk3qo566/r2q/b8w/l96/business-people.png" style="display: block;height: auto;border: 0;width: 100%;box-sizing: border-box;" width="83.125" alt="Piggy Bank Icon" title="Piggy Bank Icon" height="auto"></div></div></td></tr></table></td><td class="column column-2" width="75%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 20px;padding-left: 10px;padding-right: 20px;padding-top: 20px;vertical-align: middle;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="paragraph_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="box-sizing: border-box;"><div style="color: #3d3d3d;direction: ltr;font-family: 'Helvetica Neue',Helvetica,Arial,sans-serif;font-size: 14px;font-weight: 400;letter-spacing: 0;line-height: 120%;text-align: left;mso-line-height-alt: 16.8px;box-sizing: border-box;"><p style="margin: 0;margin-bottom: 16px;box-sizing: border-box;line-height: inherit;">&nbsp;</p><p style="margin: 0;margin-bottom: 16px;box-sizing: border-box;line-height: inherit;">La estancia de<strong style="box-sizing: border-box;">m√°s personas de las acordadas</strong>, o de animales de compa√±√≠a no especificados en la reserva, conllevar√° la expulsi√≥n inmediata de la propiedad.</p><p style="margin: 0;box-sizing: border-box;line-height: inherit;">&nbsp;</p></div></td></tr></table></td></tr></tbody></table></td></tr></tbody></table><table class="row row-7" align="center" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box;"><table class="row-content stack" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;border-radius: 0;color: #000;width: 785px;margin: 0 auto;box-sizing: border-box;" width="785"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="column column-1" width="25%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 30px;padding-left: 20px;padding-right: 10px;padding-top: 10px;vertical-align: middle;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="image_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="width: 100%;padding-right: 0;padding-left: 0;box-sizing: border-box;"><div class="alignment" align="center" style="line-height: 10px;box-sizing: border-box;"><div style="max-width: 74.812px;box-sizing: border-box;"><img src="https://d487b3526b.imgdist.com/pub/bfra/tk3qo566/75f/whx/f0u/broken-pottery-svgrepo-com.svg" style="display: block;height: auto;border: 0;width: 100%;box-sizing: border-box;" width="74.812" alt="Piggy Bank Icon" title="Piggy Bank Icon" height="auto"></div></div></td></tr></table></td><td class="column column-2" width="75%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 20px;padding-left: 10px;padding-right: 20px;padding-top: 20px;vertical-align: middle;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="paragraph_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="box-sizing: border-box;"><div style="color: #3d3d3d;direction: ltr;font-family: 'Helvetica Neue',Helvetica,Arial,sans-serif;font-size: 14px;font-weight: 400;letter-spacing: 0;line-height: 120%;text-align: left;mso-line-height-alt: 16.8px;box-sizing: border-box;"><p style="margin: 0;box-sizing: border-box;line-height: inherit;">Los hu√©spedes deben informar al anfitri√≥n de<strong style="box-sizing: border-box;">cualquier da√±o</strong>o<strong style="box-sizing: border-box;">desperfecto</strong>en la propiedad dentro de las 48 horas siguientes a su llegada. La omisi√≥n de este reporte puede conllevar a que el hu√©sped sea considerado responsable de los da√±os no declarados.</p></div></td></tr></table></td></tr></tbody></table></td></tr></tbody></table><table class="row row-8" align="center" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box;"><table class="row-content stack" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;border-radius: 0;color: #000;width: 785px;margin: 0 auto;box-sizing: border-box;" width="785"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="column column-1" width="25%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 10px;padding-left: 25px;padding-right: 10px;padding-top: 10px;vertical-align: middle;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="image_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-left: 10px;width: 100%;padding-right: 0;box-sizing: border-box;"><div class="alignment" align="center" style="line-height: 10px;box-sizing: border-box;"><div style="max-width: 80.625px;box-sizing: border-box;"><img src="https://d487b3526b.imgdist.com/pub/bfra/tk3qo566/qkr/hzx/unq/aceptar.png" style="display: block;height: auto;border: 0;width: 100%;box-sizing: border-box;" width="80.625" alt="Notes Icon" title="Notes Icon" height="auto"></div></div></td></tr></table></td><td class="column column-2" width="75%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 20px;padding-left: 10px;padding-right: 20px;padding-top: 20px;vertical-align: middle;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="paragraph_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="padding-bottom: 10px;box-sizing: border-box;"><div style="color: #3d3d3d;direction: ltr;font-family: 'Helvetica Neue',Helvetica,Arial,sans-serif;font-size: 14px;font-weight: 400;letter-spacing: 0;line-height: 120%;text-align: left;mso-line-height-alt: 16.8px;box-sizing: border-box;"><p style="margin: 0;box-sizing: border-box;line-height: inherit;"><strong style="box-sizing: border-box;">Apartamentos Cantabria no se har√° responsable por:</strong></p></div></td></tr></table><table class="paragraph_block block-2" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;word-break: break-word;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="box-sizing: border-box;"><div style="color: #3d3d3d;direction: ltr;font-family: 'Helvetica Neue',Helvetica,Arial,sans-serif;font-size: 12px;font-weight: 400;letter-spacing: 0;line-height: 120%;text-align: justify;mso-line-height-alt: 14.399999999999999px;box-sizing: border-box;"><p style="margin: 0;margin-bottom: 1px;box-sizing: border-box;line-height: inherit;">I. Negligencias o fallos de servicios atribuibles a terceros.</p><p style="margin: 0;margin-bottom: 1px;box-sizing: border-box;line-height: inherit;">II. Mal funcionamiento de piscinas, √°reas recreativas o instalaciones deportivas, cuyo uso ser√° bajo la responsabilidad del hu√©sped.</p><p style="margin: 0;margin-bottom: 1px;box-sizing: border-box;line-height: inherit;">III. Robos o p√©rdidas sufridas por los hu√©spedes en la propiedad.</p><p style="margin: 0;margin-bottom: 1px;box-sizing: border-box;line-height: inherit;">IV. Da√±os personales o materiales ocasionados por fuerzas mayores o situaciones imprevistas.</p><p style="margin: 0;margin-bottom: 1px;box-sizing: border-box;line-height: inherit;">V. Molestias por ruidos de obras cercanas.</p><p style="margin: 0;margin-bottom: 1px;box-sizing: border-box;line-height: inherit;">VI. Cortes en el suministro de agua, gas o electricidad por parte de proveedores.</p><p style="margin: 0;box-sizing: border-box;line-height: inherit;">VII. Retrasos en las reparaciones de electrodom√©sticos y calderas por servicios t√©cnicos oficiales.</p></div></td></tr></table></td></tr></tbody></table></td></tr></tbody></table><table class="row row-9" align="center" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;background-color: #fff;box-sizing: border-box;"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td style="box-sizing: border-box;"><table class="row-content stack" align="center" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;background-color: #fff;color: #000;width: 785px;margin: 0 auto;box-sizing: border-box;" width="785"><tbody style="box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="column column-1" width="100%" style="mso-table-lspace: 0;mso-table-rspace: 0;font-weight: 400;text-align: left;padding-bottom: 5px;padding-top: 5px;vertical-align: top;border-top: 0;border-right: 0;border-bottom: 0;border-left: 0;box-sizing: border-box;width: 100%;display: block;"><table class="icons_block block-1" width="100%" border="0" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;text-align: center;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="pad" style="vertical-align: middle;color: #1e0e4b;font-family: Inter,sans-serif;font-size: 15px;padding-bottom: 5px;padding-top: 5px;text-align: center;box-sizing: border-box;"><table width="100%" cellpadding="0" cellspacing="0" role="presentation" style="mso-table-lspace: 0;mso-table-rspace: 0;box-sizing: border-box;"><tr style="box-sizing: border-box;"><td class="alignment" style="vertical-align: middle;text-align: center;box-sizing: border-box;"><!--[if vml]><table align="center" cellpadding="0" cellspacing="0" role="presentation" style="display:inline-block;padding-left:0;padding-right:0;mso-table-lspace:0;mso-table-rspace:0"><![endif]--><!--[if !vml]><!--><table class="icons-inner" style="mso-table-lspace: 0;mso-table-rspace: 0;display: inline-block;margin-right: -4px;padding-left: 0;padding-right: 0;box-sizing: border-box;text-align: center;" cellpadding="0" cellspacing="0" role="presentation"><!--<![endif]--><tr style="box-sizing: border-box;"><td style="vertical-align: middle;text-align: center;padding-top: 5px;padding-bottom: 5px;padding-left: 5px;padding-right: 6px;box-sizing: border-box;margin: 0 auto;"><a href="http://designedwithbeefree.com/" target="_blank" style="text-decoration: none;box-sizing: border-box;"><img class="icon" alt="Beefree Logo" src="https://d1oco4z2z1fhwp.cloudfront.net/assets/Beefree-logo.png" height="auto" width="34" align="center" style="display: block;height: auto;margin: 0 auto;border: 0;box-sizing: border-box;"></a></td><td style="font-family: Inter,sans-serif;font-size: 15px;font-weight: undefined;color: #1e0e4b;vertical-align: middle;letter-spacing: undefined;text-align: center;box-sizing: border-box;margin: 0 auto;"><a href="http://designedwithbeefree.com/" target="_blank" style="color: #1e0e4b;text-decoration: none;box-sizing: border-box;">Designed with Beefree</a></td></tr></table></td></tr></table></td></tr></table></td></tr></tbody></table></td></tr></tbody></table></td></tr></tbody></table></body></html>"""

    # Generar el HTML completo con 3 p√°ginas
    full_html = "<html><head><title>Documento Multi-p√°gina</title></head><body>"
    
    for reserva in reservas["result"]:
        if reserva["status"] == "inquiry":
            continue

        listingID = reserva["listingMapId"]
        address,serieFact = direccionListing(token, listingID)  # Obtener la direcci√≥n una sola vez por reserva
        pagado= remainingBalance(token,reserva["id"])
        total= reserva["totalPrice"]
        # Ejecutar dos veces por cada reserva
        for _ in range(2):
            full_html += base_html.format(
                Apartamento=reserva["listingName"],
                Nombre=reserva["guestName"],
                Total_estancia=str(total) + " " + reserva["currency"],
                Pagado=str(pagado)+ " " + reserva["currency"],  # Aseg√∫rate de definir c√≥mo obtener este valor
                restante=str(total-pagado)+ " " + reserva["currency"],
                address=address,  # Usar la direcci√≥n obtenida previamente
                fechachekin=reserva["arrivalDate"],
                fechacheckout=reserva["departureDate"],
                Numero_de_huespeds=str(reserva["numberOfGuests"]),
                facturacion=serieFact
            ) + "<div style='page-break-after: always;'></div>"
        full_html += "</body></html>"
    # Generar el PDF desde HTML y mantenerlo en memoria
    
    encoded_file = base64.b64encode(full_html.encode()).decode()
    

    # Crear el mensaje de correo con SendGrid
    message = Mail(
        from_email='reservas@apartamentoscantabria.net',
        to_emails=[
        To('diegoechaure@gmail.com'),
        To('reservas@apartamentoscantabria.net'),
    ],
        subject='Chekins de hoy',
        html_content='<strong>Los bienvenidos de hoy en isla</strong>'
    )

    # Adjuntar el PDF codificado
    attachment = Attachment()
    attachment.file_content = FileContent(encoded_file)
    attachment.file_type = FileType('text/html')
    attachment.file_name = FileName('bienvenidos.html')
    attachment.disposition = Disposition('attachment')
    message.attachment = attachment

    
    try:
        sg = SendGridAPIClient(os.environ.get('SENDGRID_API_KEY'))
        response = sg.send(message)
        print(response.status_code)
        print(response.body)
        print(response.headers)
    except Exception as e:
         logging.error(f"Error en la funci√≥n: {str(e)}")

def obtener_acceso_hostaway():
    try:
        payload = {
            "grant_type": "client_credentials",
            "client_id": "81585",
            "client_secret": "0e3c059dceb6ec1e9ec6d5c6cf4030d9c9b6e5b83d3a70d177cf66838694db5f",
            "scope": "general"
        }
        headers = {'Content-type': "application/x-www-form-urlencoded", 'Cache-control': "no-cache"}
        response = requests.post(URL_HOSTAWAY_TOKEN, data=payload, headers=headers)
        response.raise_for_status()
        return response.json()["access_token"]
    except requests.RequestException as e:
        logging.error(f"Error al obtener el token de acceso: {str(e)}")
        raise

def reservasHoy(arrivalStartDate, arrivalEndDate,token):
    
    url = f"https://api.hostaway.com/v1/reservations?arrivalStartDate={arrivalStartDate}&arrivalEndDate={arrivalEndDate}&includeResources=1" 

    headers = {
        'Authorization': f"Bearer {token}",
        'Content-type': "application/json",
        'Cache-control': "no-cache",
    }
    try:
        response = requests.get(url, headers=headers)
        data = response.json()
    except Exception as e:
        raise SyntaxError(f"Error al procesar la reserva: {e}")
    return data

def direccionListing(token,listingId):
    url = f"https://api.hostaway.com/v1/listings/{listingId}" 

    headers = {
        'Authorization': f"Bearer {token}",
        'Content-type': "application/json",
        'Cache-control': "no-cache",
    }

    response = requests.get(url, headers=headers)
    data = response.json()
    serie="A"
    for field in data['result']["customFieldValues"]:
        if field["customFieldid"]==57829:
            serie=field["value"]
    

    return data['result']["address"],serie

def remainingBalance(token,idReserva):
    url= f"https://api.hostaway.com/v1/guestPayments/charges?reservationId={idReserva}"
    headers = {
        'Authorization': f"Bearer {token}",
        'Content-type': "application/json",
        'Cache-control': "no-cache",
    }
    response = requests.get(url, headers=headers)
    data = response.json()['result']
    pagado=0
    for charge in data:
        if charge['status']=="paid":
            pagado+=charge['amount']
    return pagado

@app.schedule(schedule="0 0 10 * * *", arg_name="myTimer", run_on_startup=True,
              use_monitor=False) 
def crecionBienvenido(myTimer: func.TimerRequest) -> None:
    token = obtener_acceso_hostaway()
    hoy = datetime.now().strftime('%Y-%m-%d')
    reservas= reservasHoy(hoy,hoy,token)
    enviarMail(reservas,token)
    logging.info('Python timer trigger function executed.')